<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Happy Birthday</title>
    <link rel="icon" type="image/png" href="/images/logo.png" />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradientAnimation 15s ease infinite;
        font-family: Arial, sans-serif;
      }

      body.body--ready {
        color: #fff;
      }

      .cs {
        width: 100%;
        height: 100%;
        margin: 0 auto;
        position: absolute;
        text-align: center;
      }

      .canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
      }

      .music-control {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border-radius: 50px;
        padding: 10px 15px;
        color: white;
        font-size: 14px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .music-control:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .music-control.playing {
        display: flex;
      }

      .tap-instruction {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        font-size: 18px;
        text-align: center;
        z-index: 1001;
        animation: pulse 2s infinite;
        display: none;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.8;
          transform: translate(-50%, -50%) scale(1);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.05);
        }
      }

      @keyframes gradientAnimation {
        0% {
          background-position: 0% 0%;
        }
        25% {
          background-position: 100% 0%;
        }
        50% {
          background-position: 100% 100%;
        }
        75% {
          background-position: 0% 100%;
        }
        100% {
          background-position: 0% 0%;
        }
      }

      @keyframes snowfall {
        0% {
          transform: translateY(-100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }

      .snowflakes {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .snowflake {
        position: absolute;
        color: rgba(255, 105, 180, 0.8);
        font-size: 1em;
        animation: snowfall linear infinite;
        text-shadow: 0 0 10px rgba(255, 105, 180, 0.8);
      }

      .wishes-display {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        z-index: 6;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8),
          0 0 20px rgba(255, 255, 255, 0.5);
        font-family: Arial, sans-serif;
        max-width: 80%;
        line-height: 1.5;
        transition: opacity 0.5s ease-in-out;
        opacity: 0;
        display: none;
      }

      .wishes-display.show {
        display: block;
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <canvas id="rainCanvas"></canvas>

    <audio id="backgroundMusic" loop preload="auto"></audio>

    <div class="music-control" id="musicControl">
      <i class="fas fa-music"></i>
      <span id="musicStatus">Nh·∫°c ƒëang ph√°t</span>
    </div>

    <div class="tap-instruction" id="tapInstruction">
      <i class="fas fa-hand-pointer"></i><br />
      Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ b·∫Øt ƒë·∫ßu nh√≥
    </div>

    <div class="snowflakes" id="snowflakes"></div>

    <div class="wishes-display" id="wishesDisplay"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script language="javascript">
      let animationStarted = false;

      function startBirthdayAnimation() {
        if (animationStarted) return;
        animationStarted = true;

        // B·∫Øt ƒë·∫ßu countdown tr∆∞·ªõc
        S.init();

        // Sau khi countdown k·∫øt th√∫c m·ªõi ph√°t nh·∫°c
        setTimeout(() => {
          if (customData.music && audio) {
            audio.play().then(() => {
              musicControl.classList.add("playing");
              document.getElementById("musicStatus").textContent = "Music";
            });
          }
        }, 9500); // ƒë√∫ng th·ªùi gian countdown
      }

      const urlParams = new URLSearchParams(window.location.search);
      const shortId = urlParams.get("id");

      let customData;

      if (shortId) {
        const storedData = localStorage.getItem(`birthday_${shortId}`);
        if (storedData) {
          //const parsedData = JSON.parse(storedData);
          customData = {
            name: "Ng√¥ Th·ªã Thanh Tr√†",
            age: "22",
            date: "10.01.04 - 10.01.26",
            title:
              "Happy Birthday Thanh Tr√† ‚Äì M√£i ƒë·ªânh, m√£i ch√°y, m√£i l√† Ch√® t∆∞∆°i!",
            wishes: [
              "Ch√∫c m·ª´ng xinh nh·∫≠t Thanh Tr√†!",
              "Tu·ªïi m·ªõi vui v·∫ª nh√≥!",
              "B·ªõt 'ch√°t' th√™m 'ng·ªçt' nhi√©!",
              "Tu·ªïi m·ªõi xinh ƒë·∫πp, v·∫°n ng∆∞·ªùi m√™!",
              "Khoan c√≥ b·ªì ƒë·ªÉ m√¨nh ƒë√®o ƒëi nh·∫°o!",
              "M√£i ƒë·ªânh, m√£i ch√°y, m√£i Ch√® t∆∞∆°i!",
            ],
            music: "/audio/hppd.mp3",
          };
        } else {
          customData = {
            name: "Ng√¥ Th·ªã Thanh Tr√†",
            age: "22",
            date: "10.01.04 - 10.01.26",
            title:
              "Happy Birthday Thanh Tr√† ‚Äì M√£i ƒë·ªânh, m√£i ch√°y, m√£i l√† Ch√® t∆∞∆°i!",
            wishes: [
              "Ch√∫c m·ª´ng xinh nh·∫≠t Thanh Tr√†!",
              "Tu·ªïi m·ªõi vui v·∫ª nh√≥!",
              "B·ªõt 'ch√°t' th√™m 'ng·ªçt' nhi√©!",
              "Tu·ªïi m·ªõi xinh ƒë·∫πp, v·∫°n ng∆∞·ªùi m√™!",
              "Khoan c√≥ b·ªì ƒë·ªÉ m√¨nh ƒë√®o ƒëi nh·∫°o!",
              "M√£i ƒë·ªânh, m√£i ch√°y, m√£i Ch√® t∆∞∆°i!",
            ],
            music: "/audio/hppd.mp3",
          };
        }
      } else {
        customData = {
          name: "Ng√¥ Th·ªã Thanh Tr√†",
          age: "22",
          date: "10.01.04 - 10.01.26",
          title:
            "Happy Birthday Thanh Tr√† ‚Äì M√£i ƒë·ªânh, m√£i ch√°y, m√£i l√† Ch√® t∆∞∆°i!",
          wishes: [
            "Ch√∫c m·ª´ng xinh nh·∫≠t Thanh Tr√†!",
            "Tu·ªïi m·ªõi vui v·∫ª nh√≥!",
            "B·ªõt 'ch√°t' th√™m 'ng·ªçt' nhi√©!",
            "Tu·ªïi m·ªõi xinh ƒë·∫πp, v·∫°n ng∆∞·ªùi m√™!",
            "Khoan c√≥ b·ªì ƒë·ªÉ m√¨nh ƒë√®o ƒëi nh·∫°o!",
            "M√£i ƒë·ªânh, m√£i ch√°y, m√£i Ch√® t∆∞∆°i!",
          ],
          music: "/audio/hppd.mp3",
        };
      }

      document.title = customData.title;
    </script>

    <script>
      var S = {
        init: function () {
          S.Drawing.init();
          document.body.classList.add("body--ready");

          let sequence = `|#countdown 3|HAPPY BIRTHDAY|${customData.name.toUpperCase()}|${
            customData.date
          }|HAPPY ${customData.age}+`;

          customData.wishes.forEach((wish) => {
            sequence += `|${wish}`;
          });

          S.UI.simulate(sequence);
          S.Drawing.loop(function () {
            S.Shape.render();
          });
        },
      };

      S.Drawing = (function () {
        var canvas,
          context,
          renderFn,
          requestFrame =
            window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame ||
            function (callback) {
              window.setTimeout(callback, 1000 / 60);
            };
        return {
          init: function (el) {
            canvas = document.createElement("canvas");
            canvas.className = "canvas";
            document.body.appendChild(canvas);
            context = canvas.getContext("2d");
            this.adjustCanvas();
            window.addEventListener("resize", function (e) {
              S.Drawing.adjustCanvas();
            });
          },
          loop: function (fn) {
            renderFn = !renderFn ? fn : renderFn;
            this.clearFrame();
            renderFn();
            requestFrame.call(window, this.loop.bind(this));
          },
          adjustCanvas: function () {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          },
          clearFrame: function () {
            context.clearRect(0, 0, canvas.width, canvas.height);
          },
          getArea: function () {
            return { w: canvas.width, h: canvas.height };
          },
          getContext: function () {
            return context;
          },
          drawCircle: function (p, c) {
            context.fillStyle = c.render();
            context.beginPath();
            context.arc(p.x, p.y, p.z, 0, 2 * Math.PI, true);
            context.closePath();
            context.fill();
          },
        };
      })();

      S.UI = (function () {
        var interval,
          currentAction,
          time,
          maxShapeSize = 30,
          sequence = [],
          cmd = "#",
          isSequenceComplete = false;

        function getValue(value) {
          return value && value.split(" ")[1];
        }

        function getAction(value) {
          value = value && value.split(" ")[0];
          return value && value[0] === cmd && value.substring(1);
        }

        function timedAction(fn, delay, max, reverse) {
          clearInterval(interval);
          currentAction = reverse ? max : 1;
          fn(currentAction);
          if (
            !max ||
            (!reverse && currentAction < max) ||
            (reverse && currentAction > 0)
          ) {
            interval = setInterval(function () {
              currentAction = reverse ? currentAction - 1 : currentAction + 1;
              fn(currentAction);
              if (
                (!reverse && max && currentAction === max) ||
                (reverse && currentAction === 0)
              ) {
                clearInterval(interval);
                if (sequence.length === 0 && !isSequenceComplete) {
                  isSequenceComplete = true;
                  setTimeout(function () {
                    S.Shape.scatterDots();
                    setTimeout(function () {
                      showWishes();
                    }, 1500);
                  }, 2000);
                }
              }
            }, delay);
          }
        }

        function performAction(value) {
          var action, value, current;
          sequence =
            typeof value === "object"
              ? value
              : sequence.concat(value.split("|"));
          timedAction(
            function (index) {
              current = sequence.shift();
              action = getAction(current);
              value = getValue(current);
              switch (action) {
                case "countdown":
                  value = parseInt(value) || 10;
                  value = value > 0 ? value : 10;
                  timedAction(
                    function (index) {
                      if (index === 0) {
                        if (sequence.length === 0) {
                          S.Shape.switchShape(S.ShapeBuilder.letter(""));
                        } else {
                          performAction(sequence);
                        }
                      } else {
                        S.Shape.switchShape(S.ShapeBuilder.letter(index), true);
                      }
                    },
                    2000,
                    value,
                    true
                  );
                  break;
                case "rectangle":
                  value = value && value.split("x");
                  value =
                    value && value.length === 2
                      ? value
                      : [maxShapeSize, maxShapeSize / 2];
                  S.Shape.switchShape(
                    S.ShapeBuilder.rectangle(
                      Math.min(maxShapeSize, parseInt(value[0])),
                      Math.min(maxShapeSize, parseInt(value[1]))
                    )
                  );
                  break;
                case "circle":
                  value = parseInt(value) || maxShapeSize;
                  value = Math.min(value, maxShapeSize);
                  S.Shape.switchShape(S.ShapeBuilder.circle(value));
                  break;
                default:
                  S.Shape.switchShape(
                    S.ShapeBuilder.letter(
                      current[0] === cmd ? "HacPai" : current
                    )
                  );
              }
            },
            3500,
            sequence.length
          );

          //setTimeout(function () {
          // if (sequence.length === 0 && !isSequenceComplete) {
          // isSequenceComplete = true;
          //setTimeout(function () {
          // S.Shape.scatterDots();
          //setTimeout(function () {
          // showWishes();
          //}, 1500);
          //}, 2000);
          // }
          //}, 3500 * sequence.length + 2000);
        }

        return {
          simulate: function (action) {
            performAction(action);
          },
        };
      })();

      function showWishes() {
        const wishDisplay = document.getElementById("wishesDisplay");
        const wishes =
          customData.wishes && customData.wishes.length > 0
            ? customData.wishes
            : ["Ch√∫c m·ª´ng sinh nh·∫≠t! üéâ"];

        let currentWishIndex = 0;

        function updateWish() {
          wishDisplay.classList.remove("show");
          setTimeout(() => {
            wishDisplay.textContent = wishes[currentWishIndex];
            wishDisplay.classList.add("show");
            currentWishIndex = (currentWishIndex + 1) % wishes.length;
          }, 500);
        }

        updateWish();
        setInterval(updateWish, 4000);
      }

      S.Point = function (args) {
        this.x = args.x;
        this.y = args.y;
        this.z = args.z;
        this.a = args.a;
        this.h = args.h;
      };

      S.Color = function (r, g, b, a) {
        this.r = r;
        this.g = g;
        this.b = b;
        this.a = a;
      };

      S.Color.prototype = {
        render: function () {
          return (
            "rgba(" + this.r + "," + +this.g + "," + this.b + "," + this.a + ")"
          );
        },
      };

      S.Dot = function (x, y) {
        this.p = new S.Point({
          x: x,
          y: y,
          z: 8,
          a: 1,
          h: 0,
        });
        this.e = 0.15;
        this.s = true;
        this.c = new S.Color(255, 255, 255, this.p.a);
        this.t = this.clone();
        this.q = [];
      };

      S.Dot.prototype = {
        clone: function () {
          return new S.Point({
            x: this.x,
            y: this.y,
            z: this.z,
            a: this.a,
            h: this.h,
          });
        },
        _draw: function () {
          this.c.a = this.p.a;
          S.Drawing.drawCircle(this.p, this.c);
        },
        _moveTowards: function (n) {
          var details = this.distanceTo(n, true),
            dx = details[0],
            dy = details[1],
            d = details[2],
            e = this.e * d;
          if (this.p.h === -1) {
            this.p.x = n.x;
            this.p.y = n.y;
            return true;
          }
          if (d > 1) {
            this.p.x -= (dx / d) * e;
            this.p.y -= (dy / d) * e;
          } else {
            if (this.p.h > 0) {
              this.p.h--;
            } else {
              return true;
            }
          }
          return false;
        },
        _update: function () {
          if (this._moveTowards(this.t)) {
            var p = this.q.shift();
            if (p) {
              this.t.x = p.x || this.p.x;
              this.t.y = p.y || this.p.y;
              this.t.z = p.z || this.p.z;
              this.t.a = p.a || this.p.a;
              this.p.h = p.h || 0;
            } else {
              if (this.s) {
                this.p.x -= Math.sin(Math.random() * 3.142);
                this.p.y -= Math.sin(Math.random() * 3.142);
              } else {
                this.move(
                  new S.Point({
                    x: this.p.x + Math.random() * 50 - 25,
                    y: this.p.y + Math.random() * 50 - 25,
                  })
                );
              }
            }
          }
          d = this.p.a - this.t.a;
          this.p.a = Math.max(0.1, this.p.a - d * 0.05);
          d = this.p.z - this.t.z;
          this.p.z = Math.max(1, this.p.z - d * 0.05);
        },
        distanceTo: function (n, details) {
          var dx = this.p.x - n.x,
            dy = this.p.y - n.y,
            d = Math.sqrt(dx * dx + dy * dy);
          return details ? [dx, dy, d] : d;
        },
        move: function (p, avoidStatic) {
          if (!avoidStatic || (avoidStatic && this.distanceTo(p) > 1)) {
            this.q.push(p);
          }
        },
        render: function () {
          this._update();
          this._draw();
        },
      };

      S.ShapeBuilder = (function () {
        var gap = 8,
          shapeCanvas = document.createElement("canvas"),
          shapeContext = shapeCanvas.getContext("2d"),
          fontSize = 800,
          fontFamily = "Arial, sans-serif";

        function fit() {
          shapeCanvas.width = Math.floor(window.innerWidth / gap) * gap;
          shapeCanvas.height = Math.floor(window.innerHeight / gap) * gap;
          shapeContext.fillStyle = "red";
          shapeContext.textBaseline = "middle";
          shapeContext.textAlign = "center";
        }

        function processCanvas() {
          var pixels = shapeContext.getImageData(
            0,
            0,
            shapeCanvas.width,
            shapeCanvas.height
          ).data;
          (dots = []),
            pixels,
            (x = 0),
            (y = 0),
            (fx = shapeCanvas.width),
            (fy = shapeCanvas.height),
            (w = 0),
            (h = 0);
          for (var p = 0; p < pixels.length; p += 4 * gap) {
            if (pixels[p + 3] > 0) {
              dots.push(
                new S.Point({
                  x: x,
                  y: y,
                })
              );
              w = x > w ? x : w;
              h = y > h ? y : h;
              fx = x < fx ? x : fx;
              fy = y < fy ? y : fy;
            }
            x += gap;
            if (x >= shapeCanvas.width) {
              x = 0;
              y += gap;
              p += gap * 4 * shapeCanvas.width;
            }
          }
          return { dots: dots, w: w + fx, h: h + fy };
        }

        function setFontSize(s) {
          shapeContext.font = "bold " + s + "px " + fontFamily;
        }

        function isNumber(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
        }

        function init() {
          fit();
          window.addEventListener("resize", fit);
        }
        init();

        return {
          circle: function (d) {
            var r = Math.max(0, d) / 2;
            shapeContext.clearRect(0, 0, shapeCanvas.width, shapeCanvas.height);
            shapeContext.beginPath();
            shapeContext.arc(r * gap, r * gap, r * gap, 0, 2 * Math.PI, false);
            shapeContext.fill();
            shapeContext.closePath();
            return processCanvas();
          },
          letter: function (l) {
            var s = 0;
            setFontSize(fontSize);
            s = Math.min(
              fontSize,
              (shapeCanvas.width / shapeContext.measureText(l).width) *
                0.9 *
                fontSize,
              (shapeCanvas.height / fontSize) *
                (isNumber(l) ? 0.7 : 0.6) *
                fontSize
            );
            setFontSize(s);
            shapeContext.clearRect(0, 0, shapeCanvas.width, shapeCanvas.height);
            shapeContext.fillText(
              l,
              shapeCanvas.width / 2,
              shapeCanvas.height / 2
            );
            return processCanvas();
          },
          rectangle: function (w, h) {
            var dots = [],
              width = gap * w,
              height = gap * h;
            for (var y = 0; y < height; y += gap) {
              for (var x = 0; x < width; x += gap) {
                dots.push(
                  new S.Point({
                    x: x,
                    y: y,
                  })
                );
              }
            }
            return { dots: dots, w: width, h: height };
          },
        };
      })();

      S.Shape = (function () {
        var dots = [],
          width = 0,
          height = 0,
          cx = 0,
          cy = 0;

        function compensate() {
          var a = S.Drawing.getArea();
          cx = a.w / 2 - width / 2;
          cy = a.h / 2 - height / 2;
        }

        return {
          switchShape: function (n, fast) {
            var size,
              a = S.Drawing.getArea();
            width = n.w;
            height = n.h;
            compensate();
            if (n.dots.length > dots.length) {
              size = n.dots.length - dots.length;
              for (var d = 1; d <= size; d++) {
                dots.push(new S.Dot(a.w / 2, a.h / 2));
              }
            }
            var d = 0,
              i = 0;
            while (n.dots.length > 0) {
              i = Math.floor(Math.random() * n.dots.length);
              dots[d].e = fast ? 0.3 : dots[d].s ? 0.2 : 0.15;
              if (dots[d].s) {
                dots[d].move(
                  new S.Point({
                    z: Math.random() * 20 + 10,
                    a: Math.random(),
                    h: 15,
                  })
                );
              } else {
                dots[d].move(
                  new S.Point({
                    z: Math.random() * 5 + 5,
                    h: fast ? 15 : 25,
                  })
                );
              }
              dots[d].s = true;
              dots[d].move(
                new S.Point({
                  x: n.dots[i].x + cx,
                  y: n.dots[i].y + cy,
                  a: 1,
                  z: 5,
                  h: 0,
                })
              );
              n.dots = n.dots.slice(0, i).concat(n.dots.slice(i + 1));
              d++;
            }
            for (var i = d; i < dots.length; i++) {
              if (dots[i].s) {
                dots[i].move(
                  new S.Point({
                    z: Math.random() * 20 + 10,
                    a: Math.random(),
                    h: 30,
                  })
                );
                dots[i].s = false;
                dots[i].e = 0.03;
                dots[i].move(
                  new S.Point({
                    x: Math.random() * a.w,
                    y: Math.random() * a.h,
                    a: 0.3,
                    z: Math.random() * 4,
                    h: 0,
                  })
                );
              }
            }
          },
          render: function () {
            for (var d = 0; d < dots.length; d++) {
              dots[d].render();
            }
          },
          scatterDots: function () {
            var a = S.Drawing.getArea();
            for (var d = 0; d < dots.length; d++) {
              if (dots[d].s) {
                dots[d].e = 0.01;
                dots[d].move(
                  new S.Point({
                    x: Math.random() * a.w,
                    y: Math.random() * a.h,
                    a: 0.1,
                    z: Math.random() * 2 + 1,
                    h: Math.random() * 200 + 100,
                  })
                );
                dots[d].s = false;
              }
            }

            setTimeout(function () {
              for (var d = 0; d < dots.length; d++) {
                dots[d].move(
                  new S.Point({
                    a: 0,
                    z: 0,
                    h: 50,
                  })
                );
              }
            }, 3000);
          },
        };
      })();

      //S.init();
    </script>

    <script>
      const canvas = document.getElementById("rainCanvas");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      const letters = "HAPPY BIRTHDAY ".split("");
      const fontSize = 16;
      let columns = Math.floor(window.innerWidth / fontSize);
      const drops = Array(columns).fill(1);

      function drawRainBackground() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#f584b7";
        ctx.font = fontSize + "px arial";
        for (let i = 0; i < drops.length; i++) {
          const text = letters[Math.floor(Math.random() * letters.length)];
          ctx.fillText(text, i * fontSize, drops[i] * fontSize);
          if (drops[i] * fontSize > canvas.height || Math.random() > 0.95)
            drops[i] = 0;
          drops[i]++;
        }
      }

      setInterval(drawRainBackground, 50);

      function createSnowflakes() {
        const snowflakeContainer = document.getElementById("snowflakes");
        const snowflakeSymbols = ["‚ùÑ", "‚ùÖ", "‚ùÜ", "‚ú¶", "‚úß", "‚ú©", "‚ú™", "‚ú´"];

        setInterval(() => {
          if (snowflakeContainer.children.length < 50) {
            const snowflake = document.createElement("div");
            snowflake.className = "snowflake";
            snowflake.innerHTML =
              snowflakeSymbols[
                Math.floor(Math.random() * snowflakeSymbols.length)
              ];
            snowflake.style.left = Math.random() * 100 + "vw";
            snowflake.style.fontSize = Math.random() * 20 + 10 + "px";
            snowflake.style.animationDuration = Math.random() * 3 + 2 + "s";
            snowflake.style.animationDelay = Math.random() * 2 + "s";
            snowflake.style.opacity = Math.random() * 0.8 + 0.2;

            snowflakeContainer.appendChild(snowflake);

            setTimeout(() => {
              if (snowflake.parentNode) {
                snowflake.parentNode.removeChild(snowflake);
              }
            }, 1000);
          }
        }, 300);
      }

      createSnowflakes();

      // Music functionality
      let audio = document.getElementById("backgroundMusic");
      let musicControl = document.getElementById("musicControl");
      let tapInstruction = document.getElementById("tapInstruction");
      let hasUserInteracted = false;

      if (customData.music) {
        console.log("Music found:", customData.music);
        audio.src = customData.music;
        audio.volume = 0.5;

        tapInstruction.style.display = "block";

        function handleFirstInteraction() {
          if (hasUserInteracted) return;
          hasUserInteracted = true;
          tapInstruction.style.display = "none";

          // B·∫ÆT ƒê·∫¶U COUNTDOWN NGAY L·∫¨P T·ª®C
          startBirthdayAnimation();

          // Unlock audio ·ªü task k·∫ø ti·∫øp, KH√îNG block UI
          setTimeout(() => {
            audio
              .play()
              .then(() => {
                audio.pause();
                audio.currentTime = 0;
              })
              .catch(() => {});
          }, 0);
        }

        document.addEventListener("click", handleFirstInteraction, {
          once: true,
        });
        document.addEventListener("touchstart", handleFirstInteraction, {
          once: true,
        });
        document.addEventListener("keydown", handleFirstInteraction, {
          once: true,
        });

        function toggleMusic() {
          if (audio.paused) {
            audio.play();
            document.getElementById("musicStatus").innerHTML = "Music";
          } else {
            audio.pause();
            document.getElementById("musicStatus").innerHTML = "T·∫°m d·ª´ng";
          }
        }

        musicControl.onclick = toggleMusic;

        audio.addEventListener("ended", () => {
          console.log("Music ended, looping...");
        });

        audio.addEventListener("error", (e) => {
          console.error("Audio error:", e);
          musicControl.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> L·ªói ph√°t nh·∫°c';
        });
      } else {
        console.log("No music data found");
      }
    </script>
  </body>
</html>
